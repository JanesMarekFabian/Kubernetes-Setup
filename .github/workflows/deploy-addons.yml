name: Deploy Cluster Infrastructure

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'infra/addons/**'
      - '.github/workflows/deploy-addons.yml'

jobs:
  # mirror-images:
  #   name: Mirror Images to ACR
  #   runs-on: ubuntu-latest
  #   env:
  #     ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  #     ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  #     ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  #   steps:
  #     - name: Login to ACR
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ secrets.ACR_REGISTRY }}
  #         username: ${{ secrets.ACR_USERNAME }}
  #         password: ${{ secrets.ACR_PASSWORD }}
  #
  #     - name: Mirror NGINX Ingress Controller image
  #       shell: bash
  #       run: |
  #         SOURCE_IMAGE="registry.k8s.io/ingress-nginx/controller:v1.9.4"
  #         TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/ingress-nginx/controller:v1.9.4"
  #         docker pull "$SOURCE_IMAGE"
  #         docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
  #         docker push "$TARGET_IMAGE"
  #         echo "✅ Mirrored: $SOURCE_IMAGE → $TARGET_IMAGE"
  #
  #     - name: Mirror Prometheus image
  #       shell: bash
  #       run: |
  #         SOURCE_IMAGE="quay.io/prometheus/prometheus:v2.48.0"
  #         TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/prometheus/prometheus:v2.48.0"
  #         docker pull "$SOURCE_IMAGE"
  #         docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
  #         docker push "$TARGET_IMAGE"
  #         echo "✅ Mirrored: $SOURCE_IMAGE → $TARGET_IMAGE"
  #
  #     - name: Mirror Grafana image
  #       shell: bash
  #       run: |
  #         SOURCE_IMAGE="docker.io/grafana/grafana:10.2.0"
  #         TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/grafana/grafana:10.2.0"
  #         docker pull "$SOURCE_IMAGE"
  #         docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
  #         docker push "$TARGET_IMAGE"
  #         echo "✅ Mirrored: $SOURCE_IMAGE → $TARGET_IMAGE"
  #
  #     - name: Mirror Alertmanager image
  #       shell: bash
  #       run: |
  #         SOURCE_IMAGE="quay.io/prometheus/alertmanager:v0.26.0"
  #         TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/prometheus/alertmanager:v0.26.0"
  #         docker pull "$SOURCE_IMAGE"
  #         docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
  #         docker push "$TARGET_IMAGE"
  #         echo "✅ Mirrored: $SOURCE_IMAGE → $TARGET_IMAGE"
  #
  #     - name: Mirror Metrics Server image
  #       shell: bash
  #       run: |
  #         SOURCE_IMAGE="registry.k8s.io/metrics-server/metrics-server:v0.6.4"
  #         TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/metrics-server/metrics-server:v0.6.4"
  #         docker pull "$SOURCE_IMAGE"
  #         docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
  #         docker push "$TARGET_IMAGE"
  #         echo "✅ Mirrored: $SOURCE_IMAGE → $TARGET_IMAGE"

  deploy-infrastructure:
    name: Deploy Base Infrastructure
    runs-on: self-hosted
    env:
      KUBECONFIG_INLINE: ${{ secrets.KUBECONFIG }}
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare kubeconfig
        shell: bash
        run: |
          mkdir -p "$HOME/.kube"
          # Write kubeconfig from secret (handles both plain text and base64)
          # First try base64 decode, if it fails use as plain text
          if echo "$KUBECONFIG_INLINE" | base64 -d > $HOME/.kube/config 2>/dev/null && [ -s $HOME/.kube/config ]; then
            echo "✅ Decoded base64 kubeconfig"
          else
            echo "✅ Using plain text kubeconfig"
            echo "$KUBECONFIG_INLINE" > $HOME/.kube/config
          fi
          chmod 600 "$HOME/.kube/config"
          # Verify it's valid YAML/JSON
          if ! kubectl config view --raw > /dev/null 2>&1; then
            echo "❌ Invalid kubeconfig format"
            echo "First 200 chars of config:"
            head -c 200 $HOME/.kube/config
            exit 1
          fi
          echo "✅ Kubeconfig is valid"

      - name: Verify cluster access
        shell: bash
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Check helm installation
        shell: bash
        run: |
          if ! command -v helm >/dev/null 2>&1; then
            echo "❌ Helm is not installed. Please install it on the runner server:"
            echo "   curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash"
            exit 1
          fi
          helm version

      - name: Create ACR imagePullSecret for ingress-nginx namespace
        shell: bash
        run: |
          kubectl get ns ingress-nginx >/dev/null 2>&1 || kubectl create namespace ingress-nginx
          kubectl create secret docker-registry acr-pull \
            --docker-server="${{ secrets.ACR_REGISTRY }}" \
            --docker-username="${{ secrets.ACR_USERNAME }}" \
            --docker-password="${{ secrets.ACR_PASSWORD }}" \
            -n ingress-nginx \
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl patch serviceaccount default -n ingress-nginx \
            -p '{"imagePullSecrets":[{"name":"acr-pull"}]}'

      - name: Create ACR imagePullSecret for monitoring namespace
        shell: bash
        run: |
          kubectl get ns monitoring >/dev/null 2>&1 || kubectl create namespace monitoring
          kubectl create secret docker-registry acr-pull \
            --docker-server="${{ secrets.ACR_REGISTRY }}" \
            --docker-username="${{ secrets.ACR_USERNAME }}" \
            --docker-password="${{ secrets.ACR_PASSWORD }}" \
            -n monitoring \
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl patch serviceaccount default -n monitoring \
            -p '{"imagePullSecrets":[{"name":"acr-pull"}]}'

      - name: Create ACR imagePullSecret for kube-system namespace
        shell: bash
        run: |
          kubectl create secret docker-registry acr-pull \
            --docker-server="${{ secrets.ACR_REGISTRY }}" \
            --docker-username="${{ secrets.ACR_USERNAME }}" \
            --docker-password="${{ secrets.ACR_PASSWORD }}" \
            -n kube-system \
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl patch serviceaccount default -n kube-system \
            -p '{"imagePullSecrets":[{"name":"acr-pull"}]}'

      - name: Add Helm repositories
        shell: bash
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Deploy NGINX Ingress Controller
        shell: bash
        run: |
          kubectl get ns ingress-nginx >/dev/null 2>&1 || kubectl create namespace ingress-nginx
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            -n ingress-nginx \
            -f infra/addons/values/ingress-nginx.yaml \
            --set controller.image.registry="${{ secrets.ACR_REGISTRY }}" \
            --wait --timeout 5m

      - name: Deploy Monitoring Stack (Prometheus + Grafana)
        shell: bash
        run: |
          kubectl get ns monitoring >/dev/null 2>&1 || kubectl create namespace monitoring
          helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
            -n monitoring \
            -f infra/addons/values/observability.yaml \
            --set grafana.image.registry="${{ secrets.ACR_REGISTRY }}" \
            --set prometheus.prometheusSpec.image.registry="${{ secrets.ACR_REGISTRY }}" \
            --set alertmanager.image.registry="${{ secrets.ACR_REGISTRY }}" \
            --wait --timeout 10m

      - name: Deploy Metrics Server
        shell: bash
        run: |
          if ! kubectl -n kube-system get deploy metrics-server >/dev/null 2>&1; then
            # Download manifest and replace image URL with ACR
            curl -sL https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml | \
              sed "s|registry.k8s.io/metrics-server/metrics-server|${{ secrets.ACR_REGISTRY }}/metrics-server/metrics-server|g" | \
              kubectl apply -f -
            kubectl wait --for=condition=available --timeout=5m deployment/metrics-server -n kube-system
          else
            echo "Metrics Server already deployed"
          fi

      - name: Verify deployments
        shell: bash
        run: |
          echo "=== Ingress Controller ==="
          kubectl get pods -n ingress-nginx
          echo ""
          echo "=== Monitoring Stack ==="
          kubectl get pods -n monitoring
          echo ""
          echo "=== Metrics Server ==="
          kubectl get pods -n kube-system | grep metrics-server
          echo ""
          echo "=== Cluster Status ==="
          kubectl top nodes || echo "Metrics not yet available (may take a few minutes)"

      - name: Summary
        shell: bash
        run: |
          echo "✅ Cluster Infrastructure deployed successfully!"
          echo "  - NGINX Ingress Controller: ingress-nginx namespace"
          echo "  - Prometheus + Grafana: monitoring namespace"
          echo "  - Metrics Server: kube-system namespace"
          echo "  - All images pulled from ACR: ${{ secrets.ACR_REGISTRY }}"


