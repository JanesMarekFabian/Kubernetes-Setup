name: Deploy Apps

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'deploy/**'
      - 'infra/apps/**'
      - '.github/workflows/deploy-apps.yml'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      KUBECONFIG_INLINE: ${{ secrets.KUBECONFIG }}
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      NAMESPACE: ${{ vars.DEFAULT_NAMESPACE || 'apps' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare kubeconfig
        shell: bash
        run: |
          mkdir -p "$HOME/.kube"
          cat > $HOME/.kube/config << 'EOF'
          ${KUBECONFIG_INLINE}
          EOF

      - name: Ensure ACR pull secret in namespace
        shell: bash
        run: |
          chmod +x infra/apps/ensure-acr-pull-secret.sh
          NAMESPACE="${NAMESPACE:-apps}" infra/apps/ensure-acr-pull-secret.sh "$NAMESPACE" acr-pull

      # Apply your app manifests (adjust to your structure)
      - name: Deploy manifests (kustomize if present, else plain)
        shell: bash
        run: |
          if [ -f deploy/overlays/dev/kustomization.yaml ]; then
            kubectl apply -k deploy/overlays/dev
          elif [ -d deploy/base ]; then
            kubectl apply -f deploy/base
          elif [ -d deploy ]; then
            kubectl apply -f deploy
          else
            echo "No deploy/ folder found, skipping app apply"
          fi


