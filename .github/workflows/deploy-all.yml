name: Deploy All Infrastructure Components

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-all.yml'
      - 'longhorn/**'
      - 'metrics-server/**'
      - 'ingress/**'
      - 'monitoring/**'
  workflow_dispatch:

jobs:
  deploy-longhorn:
    name: Deploy Longhorn Storage
    uses: ./.github/workflows/longhorn-deploy.yml

  deploy-metrics-server:
    name: Deploy Metrics Server
    needs: deploy-longhorn
    uses: ./.github/workflows/metrics-server-deploy.yml

  deploy-ingress:
    name: Deploy NGINX Ingress
    needs: deploy-metrics-server
    uses: ./.github/workflows/ingress-deploy.yml

  deploy-monitoring:
    name: Deploy Monitoring Stack
    needs: deploy-ingress
    uses: ./.github/workflows/monitoring-deploy.yml

  summary:
    name: Deployment Summary
    needs: [deploy-longhorn, deploy-metrics-server, deploy-ingress, deploy-monitoring]
    runs-on: self-hosted
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CICD access
        uses: ./.github/actions/setup-cicd
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Deployment Summary
        shell: bash
        run: |
          set -euo pipefail
          echo "üìä Infrastructure Deployment Summary"
          echo "===================================="
          echo ""
          
          echo "üîç Longhorn Storage:"
          if kubectl get pods -n longhorn-system >/dev/null 2>&1; then
            kubectl get pods -n longhorn-system
            echo "‚úÖ Longhorn deployed"
          else
            echo "‚ö†Ô∏è Longhorn not found"
          fi
          echo ""
          
          echo "üîç Metrics Server:"
          if kubectl get pods -n kube-system -l k8s-app=metrics-server >/dev/null 2>&1; then
            kubectl get pods -n kube-system -l k8s-app=metrics-server
            echo "‚úÖ Metrics Server deployed"
          else
            echo "‚ö†Ô∏è Metrics Server not found"
          fi
          echo ""
          
          echo "üîç NGINX Ingress:"
          if kubectl get pods -n ingress-nginx >/dev/null 2>&1; then
            kubectl get pods -n ingress-nginx
            echo "‚úÖ NGINX Ingress deployed"
          else
            echo "‚ö†Ô∏è NGINX Ingress not found"
          fi
          echo ""
          
          echo "üîç Monitoring Stack:"
          if kubectl get pods -n monitoring >/dev/null 2>&1; then
            kubectl get pods -n monitoring
            echo "‚úÖ Monitoring Stack deployed"
          else
            echo "‚ö†Ô∏è Monitoring Stack not found"
          fi
          echo ""
          
          echo "üì¶ StorageClasses:"
          kubectl get storageclass
          echo ""
          
          echo "‚úÖ All infrastructure components deployment completed!"

