apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "helper-pod-fix-controller.fullname" . }}-script
  namespace: {{ .Values.controller.namespace }}
  labels:
    {{- include "helper-pod-fix-controller.labels" . | nindent 4 }}
data:
  controller.sh: |
    #!/bin/sh
    set -eu
    
    # Helper Pod Name Fix Controller
    # Watches for PVCs that fail due to invalid helper pod names and triggers
    # the provisioner to retry by deleting failed helper pods and restarting
    # the provisioner if necessary.
    
    WATCH_INTERVAL=${WATCH_INTERVAL:-5}
    NAMESPACE=${NAMESPACE:-kube-system}
    DEBUG=${DEBUG:-false}
    
    log() {
      if [ "$DEBUG" = "true" ]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [DEBUG] $*"
      else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $*"
      fi
    }
    
    log_error() {
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $*" >&2
    }
    
    log_warn() {
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $*"
    }
    
    # Check if kubectl is available
    if ! command -v kubectl >/dev/null 2>&1; then
      log_error "kubectl not found in PATH"
      exit 1
    fi
    
    fix_invalid_helper_pods() {
      log "Checking for helper pods with invalid names..."
      deleted_count=0
      
      # Get all pods in namespace and check for invalid names (without jq)
      kubectl get pods -n "$NAMESPACE" -o name 2>/dev/null | \
        sed 's|pod/||' | \
        grep -E '^-create-pvc-|^-delete-pvc-' | \
        while read -r pod_name; do
          if [ -n "$pod_name" ]; then
            log "Deleting pod with invalid name: $pod_name"
            kubectl delete pod "$pod_name" -n "$NAMESPACE" --grace-period=0 --force 2>/dev/null && {
              deleted_count=$((deleted_count + 1))
              log "Deleted invalid pod: $pod_name"
            } || log_warn "Failed to delete pod $pod_name"
          fi
        done
      
      if [ "$deleted_count" -gt 0 ]; then
        log "Deleted $deleted_count invalid helper pods"
      fi
    }
    
    get_failed_pvcs() {
      # Get all PVCs in Pending state and check their events
      failed_count=0
      
      # Get all pending PVCs
      pvc_list=$(kubectl get pvc --all-namespaces -o wide 2>/dev/null | awk 'NR>1 && $4=="Pending" {print $1"|"$2}')
      
      if [ -z "$pvc_list" ]; then
        echo "0"
        return
      fi
      
      # Process each PVC and check events
      echo "$pvc_list" | while IFS='|' read -r namespace name; do
        if [ -z "$namespace" ] || [ -z "$name" ]; then
          continue
        fi
        
        # Get events for this PVC - simpler approach: check for ProvisioningFailed events
        # and look for invalid pod name patterns in the message
        events_output=$(kubectl get events -n "$namespace" \
          --field-selector "involvedObject.name=$name,involvedObject.kind=PersistentVolumeClaim,reason=ProvisioningFailed" \
          -o jsonpath='{range .items[*]}{.message}{"\n"}{end}' 2>/dev/null || echo "")
        
        # Check if message contains invalid pod name patterns
        # The error message contains: Pod "-create-pvc-..." or Pod "-delete-pvc-..."
        if echo "$events_output" | grep -qiE 'Pod "[-]create-pvc-|Pod "[-]delete-pvc-'; then
          log_warn "Found failed PVC $namespace/$name due to invalid pod name"
          echo "1"
        else
          echo "0"
        fi
      done | awk '{sum+=$1} END {print sum+0}'
    }
    
    restart_provisioner() {
      # Restart provisioner to fix invalid pod name issue
      provisioner_pod=$(kubectl get pods -n "$NAMESPACE" -l app=local-path-provisioner -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
      
      if [ -z "$provisioner_pod" ]; then
        log_warn "No provisioner pod found"
        return
      fi
      
      log_warn "Restarting provisioner pod: $provisioner_pod"
      kubectl delete pod "$provisioner_pod" -n "$NAMESPACE" --grace-period=0 --force 2>/dev/null && {
        log "Successfully restarted provisioner pod: $provisioner_pod"
        # Wait a bit for new pod to start
        sleep 5
      } || log_warn "Failed to restart provisioner pod"
    }
    
    main() {
      log "Helper Pod Name Fix Controller started"
      log "Watching namespace: $NAMESPACE, interval: ${WATCH_INTERVAL}s"
      
      last_restart_time=0
      restart_cooldown=300  # 5 minutes in seconds
      
      while true; do
        # Fix invalid helper pods
        fix_invalid_helper_pods
        
        # Check for failed PVCs
        failed_count=$(get_failed_pvcs)
        failed_count=${failed_count:-0}  # Default to 0 if empty
        
        # Debug: Always log failed count
        if [ "$failed_count" -gt 0 ]; then
          log_warn "Found $failed_count PVCs failing due to invalid pod names"
        else
          log "No failed PVCs detected (checked $(kubectl get pvc --all-namespaces -o wide 2>/dev/null | awk 'NR>1 && $4=="Pending"' | wc -l) pending PVCs)"
        fi
        
        # Restart provisioner if needed (with cooldown)
        current_time=$(date +%s)
        if [ $((current_time - last_restart_time)) -gt "$restart_cooldown" ]; then
          restart_provisioner
          last_restart_time=$current_time
        else
          remaining=$((restart_cooldown - (current_time - last_restart_time)))
          log "Provisioner restart on cooldown, $remaining seconds remaining"
        fi
        
        sleep "$WATCH_INTERVAL"
      done
    }
    
    # Run main function
    main

