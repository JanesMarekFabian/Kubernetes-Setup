apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "helper-pod-fix-controller.fullname" . }}-script
  namespace: {{ .Values.controller.namespace }}
  labels:
    {{- include "helper-pod-fix-controller.labels" . | nindent 4 }}
data:
  controller.py: |
    #!/usr/bin/env python3
    """
    Helper Pod Name Fix Controller
    
    Watches for PVCs that fail due to invalid helper pod names and triggers
    the provisioner to retry by deleting failed helper pods and restarting
    the provisioner if necessary.
    """
    import os
    import time
    import logging
    from datetime import datetime, timedelta
    from kubernetes import client, config
    from kubernetes.client.rest import ApiException
    
    # Setup logging
    log_level = logging.DEBUG if os.getenv("DEBUG", "false").lower() == "true" else logging.INFO
    logging.basicConfig(
        level=log_level,
        format='%(asctime)s [%(levelname)s] %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    logger = logging.getLogger(__name__)
    
    WATCH_INTERVAL = int(os.getenv("WATCH_INTERVAL", "5"))
    NAMESPACE = os.getenv("NAMESPACE", "kube-system")
    
    # Load Kubernetes config (in-cluster)
    try:
        config.load_incluster_config()
        logger.info("Loaded in-cluster Kubernetes config")
    except Exception as e:
        logger.error(f"Failed to load Kubernetes config: {e}")
        raise
    
    # Initialize API clients
    v1 = client.CoreV1Api()
    apps_v1 = client.AppsV1Api()
    
    def get_failed_pvcs():
        """Get PVCs that are failing due to invalid pod names"""
        failed_pvcs = []
        
        try:
            # Get all namespaces
            namespaces = v1.list_namespace()
            
            for ns in namespaces.items:
                namespace = ns.metadata.name
                
                try:
                    # Get PVCs in this namespace
                    pvcs = v1.list_namespaced_persistent_volume_claim(namespace)
                    
                    for pvc in pvcs.items:
                        name = pvc.metadata.name
                        status = pvc.status.phase if pvc.status else "Unknown"
                        
                        if status != "Pending":
                            continue
                        
                        # Check events for invalid pod name errors
                        try:
                            events = v1.list_namespaced_event(
                                namespace,
                                field_selector=f"involvedObject.name={name},involvedObject.kind=PersistentVolumeClaim"
                            )
                            
                            for event in events.items:
                                message = event.message or ""
                                if "Invalid value" in message and "metadata.name" in message and ("-create-pvc-" in message or "-delete-pvc-" in message):
                                    failed_pvcs.append({
                                        "name": name,
                                        "namespace": namespace,
                                        "message": message
                                    })
                                    logger.warning(f"Found failed PVC {namespace}/{name} due to invalid pod name")
                                    break
                        except ApiException as e:
                            logger.debug(f"Error getting events for {namespace}/{name}: {e}")
                            continue
                            
                except ApiException as e:
                    logger.debug(f"Error listing PVCs in {namespace}: {e}")
                    continue
            
            return failed_pvcs
        except Exception as e:
            logger.error(f"Error getting failed PVCs: {e}")
            return []
    
    def fix_invalid_helper_pods():
        """Delete any helper pods with invalid names"""
        deleted_count = 0
        
        try:
            # Get all pods in the namespace
            pods = v1.list_namespaced_pod(NAMESPACE)
            
            for pod in pods.items:
                pod_name = pod.metadata.name
                
                # Check if pod name starts with invalid prefix
                if pod_name.startswith("-create-pvc-") or pod_name.startswith("-delete-pvc-"):
                    logger.info(f"Deleting pod with invalid name: {pod_name}")
                    try:
                        v1.delete_namespaced_pod(
                            pod_name,
                            NAMESPACE,
                            grace_period_seconds=0,
                            body=client.V1DeleteOptions(propagation_policy="Foreground")
                        )
                        deleted_count += 1
                        logger.info(f"Deleted invalid pod: {pod_name}")
                    except ApiException as e:
                        logger.warning(f"Failed to delete pod {pod_name}: {e}")
            
            if deleted_count > 0:
                logger.info(f"Deleted {deleted_count} invalid helper pods")
        except ApiException as e:
            logger.error(f"Error listing pods: {e}")
        except Exception as e:
            logger.error(f"Error fixing helper pods: {e}")
    
    def restart_provisioner_if_needed():
        """Restart provisioner if it's creating invalid pod names"""
        try:
            # Get provisioner pods
            pods = v1.list_namespaced_pod(
                NAMESPACE,
                label_selector="app=local-path-provisioner"
            )
            
            if not pods.items:
                logger.debug("No provisioner pods found")
                return
            
            # Check logs of first provisioner pod
            pod_name = pods.items[0].metadata.name
            try:
                logs = v1.read_namespaced_pod_log(
                    pod_name,
                    NAMESPACE,
                    tail_lines=50
                )
                
                if logs and ("Invalid value" in logs or "metadata.name" in logs):
                    logger.warning("Provisioner logs show invalid pod name errors, restarting provisioner...")
                    
                    # Delete provisioner pod to trigger restart
                    v1.delete_namespaced_pod(
                        pod_name,
                        NAMESPACE,
                        grace_period_seconds=0,
                        body=client.V1DeleteOptions(propagation_policy="Foreground")
                    )
                    logger.info(f"Restarted provisioner pod: {pod_name}")
            except ApiException as e:
                logger.debug(f"Error reading provisioner logs: {e}")
                
        except ApiException as e:
            logger.error(f"Error restarting provisioner: {e}")
        except Exception as e:
            logger.error(f"Error in restart_provisioner_if_needed: {e}")
    
    def main():
        logger.info("Helper Pod Name Fix Controller started")
        logger.info(f"Watching namespace: {NAMESPACE}, interval: {WATCH_INTERVAL}s")
        
        last_provisioner_restart = None
        RESTART_COOLDOWN = timedelta(minutes=5)  # Don't restart more than once per 5 minutes
        
        while True:
            try:
                # Fix invalid helper pods
                fix_invalid_helper_pods()
                
                # Check for failed PVCs
                failed_pvcs = get_failed_pvcs()
                
                if failed_pvcs:
                    logger.warning(f"Found {len(failed_pvcs)} PVCs failing due to invalid pod names")
                    
                    # Restart provisioner if needed (with cooldown)
                    now = datetime.now()
                    if last_provisioner_restart is None or (now - last_provisioner_restart) > RESTART_COOLDOWN:
                        restart_provisioner_if_needed()
                        last_provisioner_restart = now
                
                time.sleep(WATCH_INTERVAL)
                
            except KeyboardInterrupt:
                logger.info("Controller stopped by user")
                break
            except Exception as e:
                logger.error(f"Error in main loop: {e}")
                time.sleep(WATCH_INTERVAL)
    
    if __name__ == "__main__":
        main()

