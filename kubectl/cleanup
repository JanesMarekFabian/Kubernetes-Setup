#!/bin/bash
set -euo pipefail

# Default Werte
NAMESPACE=""
DELETE_FAILED=false
DELETE_TERMINATING=false
DELETE_PENDING=false
WAIT_TIME=10

# Hilfe anzeigen
show_help() {
  cat <<EOF
Usage: $0 [OPTIONS]

General Kubernetes pod cleanup script for any namespace.

OPTIONS:
  -n, --namespace NAMESPACE     Namespace to clean up (required)
  --delete-failed               Delete failed pods (ImagePullBackOff/ErrImagePull)
  --delete-terminating          Delete terminating pods
  --delete-pending              Delete pending pods
  -w, --wait SECONDS           Wait time after cleanup (default: 10)
  -h, --help                    Show this help message

EXAMPLES:
  # Cleanup all failed/terminating/pending pods in monitoring namespace
  $0 -n monitoring --delete-failed --delete-terminating --delete-pending

  # Only delete failed pods in kube-system
  $0 -n kube-system --delete-failed

  # Cleanup terminating pods in default namespace
  $0 -n default --delete-terminating

  # Cleanup everything with custom wait time
  $0 -n monitoring --delete-failed --delete-terminating --delete-pending -w 5
EOF
}

# Parse Arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -n|--namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    --delete-failed)
      DELETE_FAILED=true
      shift
      ;;
    --delete-terminating)
      DELETE_TERMINATING=true
      shift
      ;;
    --delete-pending)
      DELETE_PENDING=true
      shift
      ;;
    -w|--wait)
      WAIT_TIME="$2"
      shift 2
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      echo "âŒ Unknown option: $1"
      echo ""
      show_help
      exit 1
      ;;
  esac
done

# PrÃ¼fe ob Namespace angegeben wurde
if [ -z "$NAMESPACE" ]; then
  echo "âŒ Namespace is required! Use -n or --namespace"
  echo ""
  show_help
  exit 1
fi

# PrÃ¼fe ob mindestens eine Option ausgewÃ¤hlt wurde
if [ "$DELETE_FAILED" = false ] && [ "$DELETE_TERMINATING" = false ] && [ "$DELETE_PENDING" = false ]; then
  echo "âŒ At least one cleanup option must be specified!"
  echo "   Use --delete-failed, --delete-terminating, or --delete-pending"
  echo ""
  show_help
  exit 1
fi

# PrÃ¼fe ob Namespace existiert
if ! kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
  echo "âŒ Namespace '$NAMESPACE' does not exist!"
  exit 1
fi

echo "ğŸ§¹ Starting cleanup of namespace: $NAMESPACE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Options:"
echo "  Namespace: $NAMESPACE"
echo "  Delete Failed Pods: $DELETE_FAILED"
echo "  Delete Terminating Pods: $DELETE_TERMINATING"
echo "  Delete Pending Pods: $DELETE_PENDING"
echo "  Wait Time: ${WAIT_TIME}s"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. LÃ¶sche fehlgeschlagene Pods
if [ "$DELETE_FAILED" = true ]; then
  echo "ğŸ—‘ï¸ Step 1: Deleting failed pods (ImagePullBackOff/ErrImagePull)..."
  FAILED_PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[?(@.status.containerStatuses[0].state.waiting.reason=="ImagePullBackOff" || @.status.containerStatuses[0].state.waiting.reason=="ErrImagePull" || @.status.phase=="Failed")].metadata.name}' 2>/dev/null || echo "")
  if [ -n "$FAILED_PODS" ]; then
    for pod in $FAILED_PODS; do
      echo "  ğŸ—‘ï¸ Deleting pod: $pod"
      kubectl delete pod "$pod" -n "$NAMESPACE" --grace-period=0 --force --ignore-not-found=true || true
    done
    echo "âœ… Deleted $(echo $FAILED_PODS | wc -w) failed pods"
  else
    echo "  âœ… No failed pods found"
  fi
fi

# 2. LÃ¶sche Terminating Pods
if [ "$DELETE_TERMINATING" = true ]; then
  echo ""
  echo "ğŸ—‘ï¸ Step 2: Deleting terminating pods..."
  TERMINATING_PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[?(@.metadata.deletionTimestamp!=null)].metadata.name}' 2>/dev/null || echo "")
  if [ -n "$TERMINATING_PODS" ]; then
    for pod in $TERMINATING_PODS; do
      echo "  ğŸ—‘ï¸ Force deleting terminating pod: $pod"
      kubectl delete pod "$pod" -n "$NAMESPACE" --grace-period=0 --force --ignore-not-found=true || true
    done
    echo "âœ… Deleted $(echo $TERMINATING_PODS | wc -w) terminating pods"
  else
    echo "  âœ… No terminating pods found"
  fi
fi

# 3. LÃ¶sche Pending Pods
if [ "$DELETE_PENDING" = true ]; then
  echo ""
  echo "ğŸ—‘ï¸ Step 3: Deleting pending pods..."
  PENDING_PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[?(@.status.phase=="Pending")].metadata.name}' 2>/dev/null || echo "")
  if [ -n "$PENDING_PODS" ]; then
    for pod in $PENDING_PODS; do
      echo "  ğŸ—‘ï¸ Deleting pod: $pod"
      kubectl delete pod "$pod" -n "$NAMESPACE" --grace-period=0 --force --ignore-not-found=true || true
    done
    echo "âœ… Deleted $(echo $PENDING_PODS | wc -w) pending pods"
  else
    echo "  âœ… No pending pods found"
  fi
fi

# 4. Warte kurz, damit Pods neu erstellt werden
if [ "$WAIT_TIME" -gt 0 ]; then
  echo ""
  echo "â³ Step 4: Waiting ${WAIT_TIME} seconds for pods to be recreated..."
  sleep "$WAIT_TIME"
fi

# 5. Zeige finalen Status
echo ""
echo "ğŸ“Š Final Status:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
kubectl get pods -n "$NAMESPACE"

echo ""
echo "âœ… Cleanup completed!"
